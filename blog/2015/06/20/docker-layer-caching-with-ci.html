<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Docker: Enabling Layer Caching with Distributed Continuous Integration</title>
    <meta name="description" content="I am a software developer! Here are my thoughts.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://squirly.ca/blog/2015/06/20/docker-layer-caching-with-ci.html">
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-43402257-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Tyler Jones</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/blog/2015/06/20/docker-layer-caching-with-ci.html">Docker: Enabling Layer Caching with Distributed Continuous Integration</a>
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Docker: Enabling Layer Caching with Distributed Continuous Integration</h1>
    <p class="post-meta">Jun 20, 2015</p>
  </header>

  <article class="post-content">
    <p>When using continuous integration with docker it can be difficult to achieve proper caching.
Especially when the build system is distributed.
This is because you are not always using the same docker server instance or the docker images have been purged.
This blog post details a way to preserve your docker image’s layers so that they can be cached when using a distributed continuous integration system.
This example will use CircleCI but could be expanded to any continuous integration platform.
Some of examples here are slightly modified versions of what is found in <a href="https://circleci.com/docs/docker/">CircleCi’s Docker Docs</a> and is meant to supplement it.
There are a few things that are different, these should give you an idea of the power of using continuous integration.</p>

<p>First docker needs to be enabled:
<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=1.machine_services.yml"></script></p>

<p><strong>UPDATE: Since <a href="https://github.com/docker/docker/releases/tag/v1.8.0">docker 1.8.0</a> this next step is no longer necessary because of the “Make build cache ignore mtime” addition!</strong></p>

<p>Next, during the checkout it can be useful to normalize the dates.
The two bash commands below set the mtime (modified time) of each file to the time of the commit that last modified that file.
These can be added to the post checkout section of your <code class="highlighter-rouge">circle.yml</code> file.
This will cause the update immediately after the code is available and before any further steps are run.
<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=2.post-checkout.yml"></script>
If anyone has a source on this I would be happy to add an attribution.</p>

<p><strong>Continue here…</strong></p>

<p>To be able to achieve layer caching a previous version of your docker image is needed.
To make this image available to builds it needs to be loaded on the current docker server instance.
Docker’s <code class="highlighter-rouge">save</code> and <code class="highlighter-rouge">load</code> commands give a simple way to export and import an image for this purpose.
On CircleCI, the exported file can persisted between builds so that it can be loaded on the next build.
Below is an example of how to do this in the dependency step of your <code class="highlighter-rouge">circle.yml</code> file.</p>

<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=3.dependencies.yml"></script>

<p>It can also be useful to cache any dependencies of your tests that are also docker images.
The example below makes redis and postgres images available for use later in the testing part of the build
(Add the 6th and 7th line if you are using the docker caching from example above):</p>

<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=4.other_dependencies.yml"></script>

<p>I would test the above to verify if it is actually faster than <code class="highlighter-rouge">docker pull</code> for your image.
I found that a few times a <code class="highlighter-rouge">docker pull</code> is faster but the above example is more consistent.</p>

<p>The next thing is using these images for your test.
Below, the database services are started with docker and the postgres database is created and initialized.</p>

<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=5.database_override.yml"></script>

<p>Running you test using docker is now simple. The example below links in the database service from the previous example.
The command also sets up test results to be output into the <a href="https://circleci.com/docs/test-metadata/">CircleCI reports directory in the required JUnit format</a>.</p>

<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=6.test_override.yml"></script>

<p>Now the upload files can be uploaded to Docker Hub in the deployment step.
The example below will upload all builds.
The uploaded image will be tagged with the commit’s sha id and with the branch.
This makes it easy to find images in the future and so that an environment can pull a specific branch if necessary.
<script src="https://gist.github.com/e79f74b2d65b4c1a9aae5b3e6d55d061.js?file=7.deployment.yml"></script></p>

<p>I hope this provided some insight on getting docker builds running on continuous integration and expands on <a href="https://circleci.com/docs/docker/">CircleCi’s Docker Docs</a> enough to be useful.</p>

<p>Is there anything I missed, does something need clarification, do I need to give you attribution (see above)? if so leave a comment!</p>

  </article>

  
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
          this.page.url = "http://squirly.ca/blog/2015/06/20/docker-layer-caching-with-ci.html";
          this.page.identifier = "docker-layer-caching-ci";
          this.page.title = "Docker: Enabling Layer Caching with Distributed Continuous Integration";
      };
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//squirly.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tyler Jones</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Tyler Jones</li>
          <li><a href="mailto:tyler@squirly.ca">tyler@squirly.ca</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/squirly">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">squirly</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/squirly4">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">squirly4</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">I am a software developer! Here are my thoughts.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
