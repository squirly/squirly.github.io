<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Golang: Context is Not For Dependency Injection and a Solution</title>
    <meta name="description" content="I am a software developer! Here are my thoughts.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://squirly.ca/blog/2015/04/17/golang-context-is-not-for-dependency-injection.html">
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', '', 'auto');
        ga('send', 'pageview');
    </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Tyler Jones</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/blog/2015/04/17/golang-context-is-not-for-dependency-injection.html">Golang: Context is Not For Dependency Injection and a Solution</a>
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Golang: Context is Not For Dependency Injection and a Solution</h1>
    <p class="post-meta">Apr 17, 2015</p>
  </header>

  <article class="post-content">
    <p>With the 1.7 release of Go in August 2016, the <a href="https://tip.golang.org/pkg/context/"><code class="highlighter-rouge">context</code> package</a>is added to the
<a href="https://tip.golang.org/doc/go1.7#context">standard library</a> and gets first class support in the <a href="https://tip.golang.org/pkg/net/http/#Request.Context"><code class="highlighter-rouge">net/http</code> package</a>.
This is very exciting because it allows simplified passing of data between middleware and request handlers.
This was possible before but required some inventive or non-intuitive techniques to achieve.
In this blog post,
I will go over how the <a href="https://tip.golang.org/pkg/context/#Context"><code class="highlighter-rouge">Context</code></a> type can be used for passing data in an http request,
why it is not a construct for dependency injection, and
a method for injecting dependencies into HTTP handlers.</p>

<h1 id="a-basic-example-using-context">A Basic Example Using Context</h1>

<p>Using <code class="highlighter-rouge">Context</code> with <code class="highlighter-rouge">net/http</code> in a middleware is quite simple.
A middleware can modify a request’s context before passing it to the wrapped http handler.
In the example for this section, a middleware that adds a passed string to the requests context will be created.
Starting with a non working implementation that describes what needs to be done using comments:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1a. Initial Middleware.go"></script>

<p>Modification to the context is achieved with two new methods on the <a href="https://tip.golang.org/pkg/net/http/#Request"><code class="highlighter-rouge">Request</code> type</a>:
A request has a method for getting its context, <a href="https://tip.golang.org/pkg/net/http/#Request.Context"><code class="highlighter-rouge">Request.Context</code></a>;
and a method for returning a copy of a request with a new context, <code class="highlighter-rouge">Request.WithContext</code>.
Adding these two methods to the middleware:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1b. Middleware with context.go"></script>

<p>The only other part is to modify the context.
Since the <code class="highlighter-rouge">Context</code> type is immutable, a new <code class="highlighter-rouge">Context</code> will have to be created.
Luckily, the <code class="highlighter-rouge">context</code> package provides a method for creating a modified copy of a <code class="highlighter-rouge">Context</code> with the <a href="https://tip.golang.org/pkg/context/#Context.WithValue"><code class="highlighter-rouge">context.WithValue</code> function</a>.
This function returns a new context Adding in the modification to the <code class="highlighter-rouge">Context</code>:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1c. Middleware with context value.go"></script>

<p>Cleaning it up:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1d. Middleware cleaned.go"></script>

<p>To access this value in a handler function, the <code class="highlighter-rouge">Context.Value</code> function of the request’s <code class="highlighter-rouge">Context</code> can be used.
A handler that responds to the request with the value set in the <code class="highlighter-rouge">"message"</code> key of the context is implemented below:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1e. Middleware handler.go"></script>

<p>Chaining this together in a main function with a few example endpoints:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=1f. Middleware useage.go"></script>

<p>The complete example can be seen in <a href="https://gist.github.com/squirly/4bd9dbd0a7d78d03b9527bdf4d0abeff">using-context.go</a>.</p>

<h1 id="context-and-dependency-injection-a-match-not-made-in-heaven">Context and Dependency Injection a Match not Made in Heaven</h1>

<p>I have heard some discussion of <code class="highlighter-rouge">Context</code> being used to pass dependencies into an <code class="highlighter-rouge">HttpHandler</code>. This is not a good idea! Let’s explore what this will look like and evaluate why this is a bad idea.</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=2. Context DI.go"></script>

<p>As you can see, it is quite bulky to properly get the dependency from the context.
This is also quite brittle, as each handler has to have the appropriate dependencies injected via middleware.
If all possible dependencies are injected on every request, unnecessary overhead is added to each request, as values are added to the context and each dependency has to be converted.
This also makes maintenance for testing difficult, as dependencies are not explicit making injection and mocking difficult.</p>

<h1 id="dependency-injecting-http-handlers">Dependency Injecting Http Handlers</h1>
<p>There is a simple way to have explicit and configurable dependency for http handlers, and all other modules that require dependencies. This can be achieved by adding the dependencies to the struct implementing the module. A constructor function for the module can be created that takes the dependencies of the module as parameters. This constructor and save the dependencies into the module for future use. The example in this section will illustrate this by injecting a user management service into an http handler and middleware. The dependencies in this example are defined as interfaces, this is a good practice as it will make testing simpler:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3a. struct DI sependencies.go"></script>

<p>There are constructor functions for each dependency that takes the parameters, or dependencies required to create that dependency. This is where dependencies will be injected. The signatures for these functions is below:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3b. struct DI constructors.go"></script>

<p>The implementations have been skipped for brevity. Mock implementations can be found in this gist, <a href="https://gist.github.com/squirly/ca101d0dbe31ef77dfe0a350f981a19e">user-server.go</a>.
In order for dependencies to be injected, the injector needs a place to put the dependencies. A good place for these is a struct. This struct will have parameters for all of the dependencies needed, allowing for injection. A middleware that authenticates users using basic auth can be created:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3c. struct DI auth middleware.go"></script>

<p>To create a handler that accepts dependencies, a struct implementing <code class="highlighter-rouge">http.Handler</code> can be created.</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3d.struct DI handler.go"></script>

<p>Putting this together into a main function and linking all of the dependencies is now as simple as instantiating and injecting.</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3e. struct DI example.go"></script>

<p>In this example, the overhead of manually injecting dependencies is minimal. For larger applications this could become complex and a burden to maintain. One package that simplifies dependency injection is <a href="https://github.com/facebookgo/inject">facebookgo/inject</a>. This package allows injection by passing dependencies and dependants to the library and annotating all dependencies on your structs with <code class="highlighter-rouge">`inject:""`</code>. facebookgo/inject requires that the dependencey parameters on a struct be exported, in order to allow injection. This is not the case with the example above. For this the http handler type would be rewritten:</p>

<script src="https://gist.github.com/53dcefcae05017ccb1c8419166518b6a.js?file=3f. struct DI facebookgo-inject.go"></script>

<p>There are many options for dependency injection in Go. But, before you implement, think about what you are doing and if it really is a good idea.</p>

<p>Anything need clarification? Did i get something wrong? Leave a comment or make an issue on my GitHub repo.</p>

  </article>

  
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
          this.page.url = "http://squirly.ca/blog/2015/04/17/golang-context-is-not-for-dependency-injection.html";
          this.page.identifier = "golang-context-di";
          this.page.title = "Golang: Context is Not For Dependency Injection and a Solution";
      };
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//squirly.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tyler Jones</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Tyler Jones</li>
          <li><a href="mailto:tyler@squirly.ca">tyler@squirly.ca</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/squirly">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">squirly</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/squirly4">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">squirly4</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">I am a software developer! Here are my thoughts.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
